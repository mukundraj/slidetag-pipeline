import os
# configfile: "../../configs/config.yaml"
# configfile: "../../configs/config_test.yaml"
configfile: "./build/config.yaml"


rule test:
	params: 
		p=1
	output:
		"b"
	shell:
		"echo {params.p} {output} "+config['datapath']+" > b"

rule injest_imgs:
	input: 
		nissls=config['homedir']+config['datapath']+'/nissls'+'.zip',
		stags=config['homedir']+config['datapath']+'/stags'+'.zip'
	output:
		dataset_dir=directory(config['homedir']+config['oproot']+'/'+config['dataname']),
		# stags_op=directory(config['homedir']+config['oproot']+'/'+config['dataname'])
	shell:
		"unzip {input.nissls} -d {output.dataset_dir} ; unzip {input.stags} -d {output.dataset_dir}"

fnames, = glob_wildcards(config['homedir']+config['oproot']+'/'+config['dataname']+'/nissls/{fname,[^/]+}.tif')

print (fnames)
print(config['homedir']+config['oproot']+'/'+config['dataname']+'/nissls')

# rule all:
# 	input: 
# 		nissls=expand(config['homedir']+config['oproot']+'/'+config['dataname']+'/rigid/{fname}', fname=fnames),
rule all:
	input:
		nissls=expand(config['homedir']+config['oproot']+'/'+config['dataname']+'/rigid/{fname}/{fname}.tif', fname=fnames),
		stags=expand(config['homedir']+config['oproot']+'/'+config['dataname']+'/rigid/{fname}/stag_{fname}.tif', fname=fnames),

# rule to list dir and create a rigid/folder for each file
rule create_rigid_folders:
	input:
		nissls=config['homedir']+config['oproot']+'/'+config['dataname']+'/nissls/{fname}.tif'
	output:
		nissls=directory(config['homedir']+config['oproot']+'/'+config['dataname']+'/rigid/{fname}'),
	shell:
		"mkdir -p {output.nissls}"

# rule to copy tifs
rule get_tifs:
	input:
		nissls=config['homedir']+config['oproot']+'/'+config['dataname']+'/nissls/{fname}.tif',
		stags=config['homedir']+config['oproot']+'/'+config['dataname']+'/stags/{fname}.tif',
	output:
		nissls=config['homedir']+config['oproot']+'/'+config['dataname']+'/rigid/{fname}/{fname}.tif',
		stags=config['homedir']+config['oproot']+'/'+config['dataname']+'/rigid/{fname}/stag_{fname}.tif',
	shell:
		'cp {input.nissls} {output.nissls} && cp {input.stags} {output.stags}'
		# 'mkdir -p {output.stags} && cp {input.stags}/*.tif {output.stags}'

# rule to create slicer files via python script

